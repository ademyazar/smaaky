<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Smaaky – Afrekenen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; color: #1f2937; }
        .header { background: white; border-bottom: 1px solid #e5e5e5; z-index: 10; }
        .back-btn { font-size: 24px; cursor: pointer; color: #4b5563; }
        .section-title { font-size: 20px; margin: 30px 0 15px; font-weight: 700; color: #1f2937; }
        input, textarea { padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size: 16px; width: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .toggle-btn { transition: background-color 0.2s, color 0.2s; }
        .toggle-btn.active { background: #F97316; color: white; box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.2); }
        .cart-card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .totals-box { background: white; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); }
        .checkout-btn { background: #F97316; }
        .payment-option input:checked + label { border-color: #F97316; background-color: #FFF7ED; }
        .payment-option label { transition: all 0.2s; }
    </style>
</head>
<body>

<!-- GEREKLİ PHP BİLGİLERİNİ BAŞLANGIÇTA ALIYORUZ -->
<?php
// NOT: Bu dosyanın PHP tarafından işlenmesi gerekir (örn: checkout.php veya index.php'nin bir kısmı olarak).
// Örnek olarak sepet verilerini session'dan çektiğini varsayıyoruz.
session_start();
require_once 'config.php'; // Veritabanı ve Mollie ayarlarını yükle

// Sepet ve toplam tutarı PHP Session'dan çekme
$cart_items = $_SESSION['cart'] ?? [];
$subtotal = $_SESSION['subtotal'] ?? 0;
$delivery_fee = $_SESSION['delivery_fee'] ?? 0; // Varsayılan olarak 2.50
$total = $_SESSION['total_price'] ?? $subtotal + $delivery_fee;
?>

<div class="header flex items-center gap-3 p-4 sticky top-0 bg-white shadow-sm">
    <button class="back-btn" onclick="history.back()">←</button>
    <h1 class="text-2xl font-bold">Afrekenen</h1>
</div>

<div class="container mx-auto p-4 max-w-xl">

    <!-- BEZORG / AFHALEN -->
    <div class="section-title">Bezorgmethode</div>
    <div class="flex bg-gray-200 rounded-xl p-1 mb-6">
        <div class="toggle-btn active flex-1 p-3 text-center rounded-lg font-semibold cursor-pointer" id="toggle-delivery">Bezorgd</div>
        <div class="toggle-btn flex-1 p-3 text-center rounded-lg font-semibold cursor-pointer" id="toggle-pickup">Afhalen</div>
    </div>

    <!-- ADRES FORM -->
    <div class="section-title">Jouw gegevens</div>
    <div id="address-form" class="space-y-4">
        <input type="text" id="co_name" placeholder="Naam" required>
        <input type="tel" id="co_phone" placeholder="Telefoonnummer" required>
        <input type="email" id="co_email" placeholder="E-mail (Optioneel)">
        <input type="text" id="co_street" placeholder="Straatnaam" required>
        <input type="text" id="co_house_number" placeholder="Huisnummer" required>
        <input type="text" id="co_zip" placeholder="Postcode" required>
        <input type="text" id="co_city" placeholder="Plaats" value="Rotterdam" required>
    </div>
    
    <!-- BETALINGSOPITES (Ödeme Seçenekleri) -->
    <div class="section-title">Betaalmethode</div>
    <div class="space-y-3" id="payment-options">
        
        <!-- MOLLIE Online Ödeme -->
        <div class="payment-option">
            <input type="radio" id="pay_mollie" name="payment_method" value="mollie" class="hidden" checked>
            <label for="pay_mollie" class="flex items-center justify-between p-4 border-2 border-gray-300 rounded-xl cursor-pointer">
                <span class="font-semibold flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-credit-card"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
                    Online betalen (iDEAL, Creditcard etc.)
                </span>
                <span class="text-sm font-medium text-gray-500">Aanbevolen</span>
            </label>
        </div>
        
        <!-- Nakit Ödeme -->
        <div class="payment-option">
            <input type="radio" id="pay_cash" name="payment_method" value="cash" class="hidden">
            <label for="pay_cash" class="flex items-center justify-between p-4 border-2 border-gray-300 rounded-xl cursor-pointer">
                <span class="font-semibold flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-2a2 2 0 0 0 0 4h2a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1Z"/><path d="M17 10h.01"/></svg>
                    Contant bij levering / afhalen
                </span>
            </label>
        </div>

    </div>
    
    <!-- NOTLAR -->
    <div class="section-title">Opmerkingen</div>
    <textarea id="co_note" rows="3" placeholder="Speciale wensen of allergieën"></textarea>

    <!-- ORDER OVERVIEW -->
    <div class="section-title">Jouw bestelling</div>
    <div class="cart-card p-4 space-y-3">
        <?php 
        $display_subtotal = 0;
        foreach ($cart_items as $item): 
            $item_price = $item["qty"] * $item["price"];
            foreach ($item["extras"] ?? [] as $ex){ $item_price += $ex["price"]; }
            $display_subtotal += $item_price;
        ?>
            <div class="flex justify-between items-start border-b border-gray-100 pb-3 last:border-b-0 last:pb-0">
                <div class="flex-1 pr-2">
                    <div class="font-bold text-gray-800"><?= $item["qty"] ?>x <?= htmlspecialchars($item["name"]) ?></div>
                    <?php if (!empty($item["extras"])): ?>
                        <div class="text-xs text-gray-500 pl-4 mt-0.5">
                            <?php foreach ($item["extras"] as $ex): ?>
                                • <?= htmlspecialchars($ex["name"]) ?> (+€ <?= number_format($ex["price"],2) ?>)<br>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
                <div class="font-bold text-gray-900">€ <?= number_format($item_price, 2) ?></div>
            </div>
        <?php endforeach; ?>
    </div>

</div>

<!-- STICKY TOTAL BOX -->
<div class="totals-box fixed bottom-0 left-0 right-0 p-4 shadow-2xl rounded-t-2xl">
    <div class="space-y-2 mb-4">
        <div class="flex justify-between text-base text-gray-600">
            <span>Subtotaal</span>
            <span id="subtotal">€ <?= number_format($subtotal, 2) ?></span>
        </div>
        <div class="flex justify-between text-base text-gray-600" id="delivery-row">
            <span>Bezorgkosten</span>
            <span id="delivery">€ <?= number_format($delivery_fee, 2) ?></span>
        </div>
        <!-- İndirim satırı da buraya eklenebilir, şimdilik sadece toplamı kullanıyoruz -->
        <div class="flex justify-between pt-2 border-t border-gray-200 text-xl font-extrabold">
            <span>Totaal</span>
            <span id="total">€ <?= number_format($total, 2) ?></span>
        </div>
    </div>

    <button class="checkout-btn w-full py-4 rounded-xl font-bold text-lg hover:bg-orange-700 transition-colors" onclick="submitOrder()">Bestelling plaatsen</button>
</div>

<div class="h-40"></div> <!-- Sticky footer için boşluk -->

<script>
// PHP'den gelen bilgileri JS değişkenlerine aktar
const SUB_TOTAL = <?= $subtotal ?>;
const DELIVERY_FEE = <?= $delivery_fee ?>;
const TOTAL = <?= $total ?>;
const CART_ITEMS = <?= json_encode($cart_items) ?>;

let currentMode = "delivery";

// MOD SEÇİMİNİ İŞLEME
document.getElementById("toggle-delivery").onclick = () => { currentMode = "delivery"; toggleMode(); updateTotals(); };
document.getElementById("toggle-pickup").onclick = () => { currentMode = "pickup"; toggleMode(); updateTotals(); };

function toggleMode() {
    document.getElementById("toggle-delivery").classList.toggle("active", currentMode === "delivery");
    document.getElementById("toggle-pickup").classList.toggle("active", currentMode === "pickup");
    
    const isDelivery = currentMode === "delivery";
    document.getElementById("address-form").style.display = isDelivery ? 'block' : 'none';
    document.getElementById("delivery-row").style.display = isDelivery ? 'flex' : 'none';
}

function updateTotals() {
    let finalTotal = SUB_TOTAL;
    let currentDeliveryFee = 0;
    
    if (currentMode === "delivery") {
        currentDeliveryFee = DELIVERY_FEE;
        finalTotal += DELIVERY_FEE;
    }

    document.getElementById("delivery").innerText = "€ " + currentDeliveryFee.toFixed(2).replace('.', ',');
    document.getElementById("total").innerText = "€ " + finalTotal.toFixed(2).replace('.', ',');
}

// SAYFA YÜKLENİRKEN BAŞLANGIÇ DEĞERLERİNİ AYARLA
toggleMode();


// SIPARIŞI GÖNDERME İŞLEVİ
function submitOrder(){
    const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
    
    // Basit Validasyon
    const name = document.getElementById("co_name").value.trim();
    const phone = document.getElementById("co_phone").value.trim();
    
    if (!name || !phone) {
        alert("Vul alstublieft uw naam en telefoonnummer in.");
        return;
    }

    let street = '';
    let house_number = '';
    let zip = '';
    let city = '';
    
    if (currentMode === "delivery") {
        street = document.getElementById("co_street").value.trim();
        house_number = document.getElementById("co_house_number").value.trim();
        zip = document.getElementById("co_zip").value.trim();
        city = document.getElementById("co_city").value.trim();
        
        if (!street || !house_number || !zip || !city) {
            alert("Vul alstublieft het volledige bezorgadres in.");
            return;
        }
    }
    
    const deliveryFeeToSend = currentMode === "delivery" ? DELIVERY_FEE : 0;
    
    const formData = new URLSearchParams();
    
    // Müşteri ve Sipariş Detayları
    formData.append('customer_name', name);
    formData.append('phone', phone);
    formData.append('delivery_type', currentMode);
    formData.append('payment_method', paymentMethod);
    formData.append('note', document.getElementById("co_note").value.trim());
    
    // Adres Detayları (Sadece delivery ise gönderilir)
    if (currentMode === 'delivery') {
        formData.append('street', street);
        formData.append('house_number', house_number);
        formData.append('zip', zip);
        formData.append('city', city);
    }
    
    // Fiyat Detayları (PHP/Session'dan gelen değerler, bu sunucu tarafında da doğrulanacaktır)
    formData.append('total_price', TOTAL);
    formData.append('delivery_fee', deliveryFeeToSend);
    
    // FETCH CALL'u yeni PHP endpoint'ine gönder
    // NOT: checkout.php'nin bulunduğu dizine göre yol ayarlanmalı. 
    // Eğer form, checkout.php'den ayrı bir HTML dosyasındaysa, yol 'checkout.php' olmalıdır.
    fetch("checkout.php", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: formData.toString()
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            if (data.payment_type === 'mollie' && data.redirect_url) {
                // Mollie ödemesi için yönlendir
                window.location.href = data.redirect_url;
            } else {
                // Nakit veya başka bir çevrimdışı ödeme için sipariş durum sayfasına yönlendir
                window.location.href = data.redirect_url; // order_status.php?order_id=X
            }
        } else {
            // Sunucu tarafından gelen hata mesajı
            alert("Bestelling mislukt: " + data.message);
        }
    })
    .catch(err => {
        console.error(err);
        alert("Er is een onbekende fout opgetreden. Probeer het later opnieuw.");
    });
}
</script>

</body>
</html>